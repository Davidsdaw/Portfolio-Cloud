name: Upload to ECR

on:
  # push:
  #   branches:
  #     - main
  workflow_dispatch:
    inputs:
      image-tag:
        description: 'Imagen tag (opcional). Si no se proporciona, se usará el SHA del commit.'
        required: false

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      - name: Set and sanitize IMAGE_TAG
        id: set-image-tag
        run: |
          IMAGE_TAG="${{ github.event.inputs.image-tag || github.sha }}"
          IMAGE_TAG=$(echo "$IMAGE_TAG" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9._-]/-/g' | sed 's/^-*//; s/-*$//')
          echo "Using IMAGE_TAG=$IMAGE_TAG"
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      - name: Check ECR repository exists
        id: check-repo
        env:
          AWS_REGION: ${{ secrets.AWS_REGION }}
          ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
        run: |
          if aws ecr describe-repositories --repository-names "$ECR_REPOSITORY" --region "$AWS_REGION" >/dev/null 2>&1; then
            echo "Repository exists: $ECR_REPOSITORY"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "Repository does not exist: $ECR_REPOSITORY — skipping push"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Build and push image to ECR
        if: steps.check-repo.outputs.exists == 'true'
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
